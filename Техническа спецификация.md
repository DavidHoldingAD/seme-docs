# Система за електронен обмен на съобщения (СЕОС)
# Техническа спецификация
## версия 1.1-beta1, март 2017
## Държавна агенция "Електронно управление"

### Съдържание

1. [Съдържание](#съдържание)
2. [Версии](#версии)
3. [Въведение](#въведение)
4. [Общи положения](#общи-положения)
	1. [Използвани термини](#използвани-термини)
	2. [Транспортна среда](#транспортна-среда)
	3. [Транспортни сертификати](#транспортни-сертификати)
5. [Регистър на участниците](#регистър-на-участниците)
	1. [Структура на регистъра](#структура-на-регистъра)
	2. [Услуги](#услуги)
	3. [Видове услуги](#видове-услуги)
		* [Типове услуги и идентификатори на услуги](#типове-услуги-и-идентификатори-на-услуги)
	4. [Актуализиране на регистъра](#актуализиране-на-регистъра)
	5. [Транспортен слой SOAP-over-HTTPS](#транспортен-слой-soap-over-https)
	6. [Протокол за комуникация](#протокол-за-комуникация)
6. [Обмен на съобщения между участниците](#обмен-на-съобщения-между-участниците)
	1. [Транспортен слой SOAP-over-HTTPS](#транспортен-слой-soap-over-https-1)
	2. [Протокол за комуникация](#протокол-за-комуникация-1)
	3. [Изпращане на съобщение](#изпращане-на-съобщение)
	4. [Получаване на съобщение](#получаване-на-съобщение)
	5. [Съобщения](#съобщения)
		1. [Заявление за регистриране на документ](#заявление-за-регистриране-на-документ)
			* [Забележки към елементите `DocID`, `DocParentID` и `GUID` на документите](#забележки-към-елементите-docid-docparentid-и-guid-на-документите)
		2. [Известие за състояние на документ](#известие-за-състояние-на-документ)
		3. [Заявление за проверка на състоянието на документ](#заявление-за-проверка-на-състоянието-на-документ)
		4. [Известие за грешка](#известие-за-грешка)
7. [Среда за обмен на съобщения](#среда-за-обмен-на-съобщения)
	1. [Тестова среда за обмен на съобщения](#тестова-среда-за-обмен-на-съобщения)
	2. [Официална среда за обмен на съобщения](#официална-среда-за-обмен-на-съобщения)
8. [Приложения](#приложения)
	1. [Описание на услугата на регистъра](#приложение-1-описание-на-услугата-на-регистъра)
	2. [Описание на съобщенията на регистъра](#приложение-2-описание-на-съобщенията-на-регистъра)
	3. [Описание на услугата на участниците](#приложение-3-описание-на-услугата-на-участниците)
	4. [Описание на съобщенията между участниците](#приложение-4-описание-на-съобщенията-между-участниците)

### Версии

* 1.0 (март 2012)
	* Първоначална версия.
* 1.1-beta1 (март 2017)
	* Добавени са уточнения.
	* Актуализиран е административният орган.
	* Актуализирана е топологията на средата.
	* Добавени са препоръки към транспортната среда и проверката на сертификатите.
	* Премахнат е примерът с ЕСОЕД.
	* Отстранени са дребни грешки.

### Въведение

Настоящият документ описва протокол за Системата за обмен на електронни съобщения (СЕОС) разработен по инициатива на Министерство на транспортните, информационните технологии и съобщенията (МТИТС) в началото на 2012 г. от смесен екип на водещи фирми в разработката на решения за управление на документи и работни процеси:

* ДАВИД Холдинг АД;
* Индекс България ООД;
* СИЕНСИС АД;
* Софтуерна група "АКСТЪР";
* Информационно обслужване АД.

Целта на документа е да опише реализираното и внедрено в държавната администрация решение за електронен обмен на съобщения. Той е от критична важност за ефективността на държавната администрация като цяло и гръбнак на електронното управление. Затова всяко едно решение в тази насока трябва да се характеризира с висока степен на ефективност, надеждност, сигурност, гъвкавост и скалируемост. Това са и целите, които си поставя настоящият протокол и всяка негова следваща версия.

Участие в обмена могат да взимат органите на централната и местната администрация, държавни предприятия и други субекти __различими по ЕИК__.

Настоящата версия на протокола дава възможност за изпращане на документи и справка за тяхното състояние.

### Общи положения

#### Използвани термини

* **Участник** – всеки субект включен[^1] в обмена на електронни съобщения по настоящия протокол;
* **Регистър на участниците** – централно хранилище на участниците в обмена на електронни съобщения;
* **Крайна точка** – софтуерен компонент участващ в обмена на съобщения, който може изпраща и получава съобщения;
* **Цифров сертификат** – електронен документ издаден от доставчик на удостоверителни услуги, който удостоверява принадлежността на X.509 публичен ключ (вж. [RFC 2459](https://tools.ietf.org/html/rfc2459)) на субект в обмена на съобщения;
* **Списък с отменени сертификати** – списък от отменени сертификати (*certificate revocation list*) поддържан от издателя на съответния сертификат (вж. [RFC 5280](https://www.ietf.org/rfc/rfc5280.txt)).

#### Транспортна среда

Описаният в настоящото описание електроннен обмен се осъществява в обща мрежова среда.

Комуникацията се осъществява по TCP/IP протокол.

Обменът на съобщения между участниците е директна (*peer-to-peer*) и това налага __директна двупосична свързаност между крайните точки на участниците__.

Достъпът до регистъра на участниците е директен и това налага __директна еднопосочна свързаност между крайните точки на участниците от една страна и крайните точки на регистъра на участниците от друга__.

Проверката за валидност на сертификатите налага също така __директна еднопосочна свързаност между крайните точки на участниците от една страна и списъците с отменени сертификати от друга__.

**Допустимо** е мрежовата среда да бъде и Интернет при достатъчно висока защитеност на използваните транспортни сертификати.

**Препоръчително** е адресирането на участниците по *hostname*, вместо по IP адрес, което:

* спестява нуждата от обновяване на информацията в регистъра, при смяна на IP адрес;
* позволява скалируемост чрез разпределяне на заявките към няколко IP адреса.

**Препоръчително** е използваният порт за комуникация **да бъде** в диапазона от 1024 до 49151 и **да не бъде** сред регистрираните в [списъка на IANA](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.txt).

Регистърът предоставя потребителски интерфейс, с който всеки участник да може да актуализира на информацията за себе си, и това налага __директна еднопосочна свързаност между участниците от една страна и крайните точки на регистъра на участниците от друга__.

#### Транспортни сертификати

Транспортните сертификати са цифрови сертификати използвани ексклузивно за достъп до регистъра на участниците и за обмена на съобщения по настоящия протокол.

За издаването на сертификатите се използва специално преназначена за целта на обмена удостоверителна верига на Информационно обслужване АД.[^2]

Проверката на транспортните сертификати от страните участващи в обмена включва:

* **Задължителна е** проверка на датата на изтичане на сертификата;
* **Задължителна е** проверка на сертификата за наличие в списъците с отменени сертификати на издателя;
* **Препоръчително е** сверяване на полето "*Common Name*" на сървърния сертификат с наименованието на сървъра обслужващ крайната точка на участника.

### Регистър на участниците

Регистърът на участниците цели да поддържа актуални данни за участниците в обмена на съобщения, т.ч. основна информация за участниците (ЕИК, наименование, информация за технически контакт) и техните крайните точки (протоколите, адреси и състояние).

Регистърът предоставя на участниците програмен интерфейс за извличане на информация за останалите участници вписани в него.

Регистърът предоставя на всеки участник потребителски интерфейс за актуализиране на информацията съхранявана за него.

#### Структура на регистъра

За всеки участник регистърът предоставя следната информация:

* Уникален идентификатор (GUID) на участника;
* Уникален идентификатор (GUID) на родителски участник, ако има такъв (ако настоящият участник е клон на друг участник) [^3];
* Идентификатор на участника (ЕИК);
* Наименование на участника;
* Данни за технически контакт:
	* Телефонен номер;
	* Факс номер;
	* Адрес на електронна поща.
* Статус ("активен" или "неактивен");
* Дата/час на последна промяна;
* Сериен номер на транспортния сертификат;
* Списък с предоставяни услуги, всяка от които съдържа следната информация: [^4]
	* Уникален идентификатор (GUID) на вида на услугата;
	* Наименование на услугата;
	* Тип на услугата (вж. [Услуги](#услуги));
	* Версия на услугата (вж. [Услуги](#услуги));
	* Идентификатор за достъп до услугата;
	* Статус ("активен", "временно неактивен" или "неактивен").

#### Услуги

Услугите (крайните точки за достъп) се различават по вид и тип.

##### Видове услуги

Всеки вид услуга има своето наименование и уникален идентификатор (GUID).

Към момента са определени следните видове услуги:

| **Наименование** | **Идентификатор**                    |
| ---------------- | ------------------------------------ |
| Документооборот  | 7060efa8-f1fa-4938-8b2b-12a78c86988f |
| ...              | ...                                  |

##### Типове услуги и идентификатори на услуги

Типът услуга определя протокола за достъп до нея, а идентификаторът (URI) за достъп – адресът на крайната точка.

Към момента са дефинирани следните типове услуги и видове идентификатори:

| **Наименование**              | **Код** | **Идентификатор**        | **Примерен идентификатор** |
| ----------------------------- | ------- | ------------------------ | -------------------------- |
| Електронен обмен на съобщения | service | Адрес на уеб услугата    | [https://agency.egov.bg:8443/EGovExchange](https://agency.egov.bg:8443/EGovExchange)
| Електронна поща               | email   | Електрноен адрес         | [mailto:agency@egov.bg](mailto:agency@egov.bg)

#### Актуализиране на регистъра

Потребителският достъп до информацията в регистъра се осъществява с използването на стандартен уеб браузер по защитен с помощта на [транспортни сертификати](#транспортни-сертификати) [HTTPS](https://tools.ietf.org/html/rfc2818) канал. Потребителят **трябва** да обърне внимание на проверката на сертификата на регистъра, която браузерът извършва, а регистърът **трябва** да осъществи проверка на сертификата на отсрещната страна (вж.[Транспортни сертификати](#транспортни-сертификати)) и да го използва за автентикация и авторизация на извикването. 

#### Транспортен слой SOAP-over-HTTPS

Програмният достъп до информацията в регистъра се осъществява с използването на [SOAP 1.1](https://www.w3.org/TR/2000/NOTE-SOAP-20000508/) уеб услуги по защитен с помощта на [транспортни сертификати](#транспортни-сертификати) [HTTPS](https://tools.ietf.org/html/rfc2818) канал.

При осъществяване на достъп до уеб услугите на регистъра, всяка от двете страни **трябва** да осъществи проверка на сертификата на отсрещната страна (вж.[Транспортни сертификати](#транспортни-сертификати)) и да го използва за автентикация и авторизация на извикването.

#### Протокол за комуникация

Протоколът за комуникация е описан от:

* [**Приложение 1. Описание на услугата на регистъра**](#приложение-1-описание-на-услугата-на-регистъра) – WSDL описание на операциите предлагани от уеб услугата на регистъра;
* [**Приложение 2. Описание на съобщенията на регистъра**](#приложение-2-описание-на-съобщенията-на-регистъра) – XSD схема описваща данните предоставяни от уеб услугата на регистъра.

### Обмен на съобщения между участниците

#### Транспортен слой SOAP-over-HTTPS

Обментът на съобщения между участниците се осъществява с използването на [SOAP 1.1](https://www.w3.org/TR/2000/NOTE-SOAP-20000508/) уеб услуги по защитен с помощта на [транспортни сертификати](#транспортни-сертификати) [HTTPS](https://tools.ietf.org/html/rfc2818) канал.

Изпращащата страна трябва да използва своя транспортен сертификат като клиентски сертификат, а получаващата страна трябва да използва своя транспортен сертификат като сървърен.

Всяка от двете страни **трябва** да провери сертификата използван от отсрещната страна (вж.[Транспортни сертификати](#транспортни-сертификати)).

#### Протокол за комуникация

Протоколът за комуникация е описан от:

* [**Приложение 3. Описание на услугата на участниците**](#приложение-3-описание-на-услугата-на-участниците) – WSDL описание на операциите предлагани от уеб услугата на на всеки участник;
* [**Приложение 4. Описание на съобщенията между участниците**](#приложение-4-описание-на-съобщенията-между-участниците) – XSD схема описваща данните обменяни от уеб услугата на всеки участник и клиентските приложения.

Всяко съобщение обменяно по протокола представлява XML документ със следната структура:

* `Header` – заглавна част. Съдържа следните данни:
	* `Version` (`string`) – версия на протокола (понастоящем "1");
	* `MessageType` (`MessageType`) – вид на съобщението;
	* `MessageDate` (`dateTime`) – дата/час на съобщението;
	* `MessageGUID` (`GUIDType`) – уникален идентификатор на съобщението;
	* `Sender` (`EntityNodeType`) – подател;
		* `Identifier` (`string`) – ЕИК/БУЛСТАТ на подателя;
		* `AdministrativeBodyName` (`string`) – наименование на подателя;
		* `GUID` (`GUIDType`) – уникален идентификатор на подателя в регистъра;
	* `Recipient` (`EntityNodeType`) – получател;
		* `Identifier` (`string`) – ЕИК/БУЛСТАТ на получателя;
		* `AdministrativeBodyName` (`string`) – наименование на получателя;
		* `GUID` (`GUIDType`) – уникален идентификатор на получателя в регистъра;
* `Body` – съдържание на съобщението. Може да съдържа един от следните елементи:
	* `DocumentRegistrationRequest` (`DocumentRegistrationRequestType`) – заявление за регистриране на документ;
	* `DocumentStatusRequest` (`DocumentStatusRequestType`) – заявление за проверка на състоянието на документ;
	* `DocumentStatusResponse` (`DocumentStatusResponseType`) – известие за състояние на документ;
	* `Error` (`ErrorMessageType`) – съобщение за грешка при обработка;
* `Signature` (`ds:Signature`) – електронен подпис на съобщението с транспортния сертфикат по стандарта [XML Signature Syntax and Processing (2nd Edition)](http://www.w3.org/TR/xmldsig-core/). Елементът трябва да съдържа информация за сертификата използван за подписване;

Проверката на участници се извършва, както по уникален идентификатор (GUID) на участника, така и по идентификатор (ЕИК/БУЛСТАТ) на организацията.

Обменът (изпращането и получаването) могат да бъдат:

* **Успешен** – когато целият процес на обмен е минал без проблеми;
* **Неуспешни** – когато на някой от етапите на обмен се е получила грешка или изключение. Неуспешният обмен бива:
	* **Изключение** – ...;
	* **Предупреждение** – ...;
	* **Грешка при подателя** – ...;
	* **Грешка при получателя** – ...;

#### Изпращане на съобщение

От страна на подателя изпращането на съобщение трябва да следва следната процедура:

1. Проверява се изходящото съобщение:
	1. Проверява се дали изходящото съобщение е валиден XML документ. Ако не, обменът се счита за "**неуспешен – грешка при подателя**";
	2. Проверява се дали изходящото съобщение е съобразено с XSD схемите за обмен на съобщения ([Приложение 4](#приложение-4-описание-на-съобщенията-между-участниците)). Ако не, обменът се счита за "**неуспешен – грешка при подателя**";
	3. Проверява се дали подателят на съобщението съществува в списъка с участниците от регистъра. Ако не, обменът се счита за "**неуспешен – грешка при подателя**";
	4. Проверява се дали получателят на съобщението съществува в списъка с участниците от регистъра. Ако не, обменът се счита за "**неуспешен – грешка при подателя**";
	5. Проверява се дали съобщението е електронно подписано. Ако не, обменът се счита за "**неуспешен – грешка при подателя**";
	6. Проверява се дали съобщението е електронно подписано с транспортния сертификат на подателя. Ако не е, обменът се счита за "**неуспешен – грешка при подателя**";
2. Установява връзка до избраната крайната точка на участника;
3. Проверява дали издателят и серийния номер на сървърния сертификат съвпадат със записаните в базата данни за съответния участник. Ако не – изпращането се прекратява, а обменът се счита за "**неуспешен – изключение"** ;
4. Изпраща съобщението. В случай на грешка (**fault**), обменът се счита за "**неуспешен – изключение"** тя се третира като предупреждение и прекратява изпращането на съобщението за по-късен етап;
5. Ако извикването е върнало синхронен отговор (съобщение различно от `null`):
	1. Проверява се дали отговорът е валиден XML документ. Ако не, обменът се счита за "**неуспешен – грешка при получателя**";
	2. Проверява се дали отговорът е съобразен с XSD схемите за обмен на съобщение (вж. [Приложение 4](#приложение-4-описание-на-съобщенията-между-участниците)). Ако не, обменът се счита за "**неуспешен – грешка при получателя**";
	3. Проверява се дали подателят на отговора съвпада с получателя на първоначалното съобщение. Ако не, обменът се счита за "**неуспешен – грешка при получателя**";
	4. Проверява се дали получателят на отговора съвпада с подателя на първоначалното съобщение. Ако не, обменът се счита за "**неуспешен – грешка при получателя**";
	5. Проверява се дали отговорът е електронно подписан. Ако не е, обменът се счита за "**неуспешен – грешка при получателя**";
	6. Проверява се дали отговорът е електронно подписан с транспортния сертификат съответстващ на подателя на отговора. Ако не е, обменът се счита за "**неуспешен – грешка при получателя**";
	7. Проверява се дали уникалният идентификатор (`MessageGUID`) на отговора съществува в базата. Ако съществува, обменът се счита за "**неуспешен – грешка при получателя**";
	8. Ако отговорът е съобщение от тип `ErrorMessageType`:
		1. Проверява се дали уникалният идентификатор на първоначалното съобщение указан в тялото на отговора съвпада с уникалния идентификатор (`MessageGUID`) на първоначалното съобщение. Ако не, обменът се счита за "**неуспешен – грешка при получателя**";
		2. Проверява се вида на грешката:
			* Ако грешката е "вътрешна", обменът се счита за "**неуспешен – грешка при получателя**";
			* Ако грешката е "външна", обменът се счита за "**неуспешен – грешка при подателя**";
6. Обменът се счита за "**успешен**".

#### Получаване на съобщение

От страна на получателя изпращането на съобщение трябва да следва следната процедура:

1. Подателят осъществява връзка до крайната точка на получателя;
2. Проверява дали е наличен клиентски сертификат. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
3. Проверява дали изпратеното съобщение е валиден XML документ. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
4. Проверява дали изпратеното съобщение е съобразено с XSD схемите за обмен на съобщение (вж. [Приложение 4](#приложение-4-описание-на-съобщенията-между-участниците)). Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
5. Проверява дали получателят на съобщението съвпада с участник, за който настоящата крайна точка отговаря. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
6. Проверява дали подателят на съобщението съвпада с активен участник от регистъра на участниците. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
7. Проверява дали клиентският сертификат съвпада с транспортния сертификата на участника на подателя от регистъра на участниците. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
8. Проверява дали съобщението е електронно подписано. Ако не е, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
9. Проверява дали съобщението е електронно подписано с транспортния сертификат съответстващ на подателя на съобщението. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
10. Проверява дали уникалният идентификатор на съобщението съществува в базата. Ако съществува, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при подателя**";
11. Обработва съобщението. Ако обработката е неуспешна, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
12. Ако обработката дава резултат:
	1. Проверява се дали отговорът е валиден XML документ. Ако не е, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
	2. Проверява дали отговорът е съобразен с XSD схемите за обмен на съобщение (вж. [Приложение 4](#приложение-4-описание-на-съобщенията-между-участниците)). Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
	3. Проверява се дали подателят на съобщението съвпада с получателя на първоначалното съобщение. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
	4. Проверява се дали получателят на съобщението съвпада с подателя на първоначалното съобщение. Ако не, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
	5. Проверява се дали отговорът е електронно подписан. Ако не е, извикването генерира изключение, а обменът се счита за "**неуспешен – грешка при получателя**";
	6. Проверява се дали отговорът е електронно подписан с транспортния сертификат на подателя му. Ако не е, обменът се счита за "**неуспешен – грешка при получателя**";
13. Обменът се счита за "**успешен**".

### Съобщения

В момента се поддържат четири вида съобщения, като техните XSD схеми могат да бъдат намерени в [Приложение 4](#приложение-4-описание-на-съобщенията-между-участниците).

#### Заявление за регистриране на документ

Този вид съобщение се използва, за да се изпрати документ, регистриран в една администрация, до друга такава, участваща в обмена. `Body` елементът, който съдържа съществената част на съобщението, е от тип `DocumentRegistrationRequestType`, който служи за описание данните за изпращания документ.

Някои основни елементи в съобщението:

* `DocID` (`DocumentIdentificationType`) – съдържа идентификатор на изпращания документ. Той се състои от:
	* Номер на документ (`DocumentNumber`) или УРИ на документ (`DocumentURI`);
	* GUID на документа (`DocumentGUID`) – генерира се от страната изпращач.
* `DocParentID` (`DocumentIdentificationType`) – съдържа идентификатор на преписката на изпращания документ. Използва за свръзване на изпращания документ към преписка в страната получател. Състои се от:
	* Номер на преписка (инициаращ документ) (`DocumentNumber`) или УРИ на преписка (иницииращ документ) (`DocumentURI`);
	* GUID на преписка (инициаращ документ) (`DocumentGUID`).
* `DocCorrespondentList` (списък от елементи от тип `CorrespondentType`) – съдържа информация за кореспондентите на документа. Всеки от тях се описва с име, адрес, ЕГН или ЕИК и други допълнителви полета;
* `DocAttachmentList` (списък от елементи от тип `AttachmentFileType`) – съдържа информация за файловото съдържание на изпращания документ. Включва име на файл, MIME тип и същинското съдържание като (`base64Binary`)[https://www.w3.org/TR/xmlschema-2/#base64Binary];
* `DocAbout` – кратко описание на документа;
* `DocService` – елемент резервиран за бъдеща употреба. Той има значение когато изпращание документ е заявление за изготвяне на административна услуга и съдържа следните данни:
	* `ServiceName` – име на изпълняваната административна услуга;
	* `ServiceType` – вид на изпълняваната административна услуга – нормална, бърза или експресна;
	* `ServiceCode` – идентификатор на административната услуга.

##### Забележки към елементите `DocID`, `DocParentID` и `GUID` на документите

* Елементът `DocParentID` винаги се попълва с данните за преписката (иницииращия документ). При изпращане на иницииращ документ от преписка към друга организация, двата елемента `DocID` и `DocParentID` са с еднакво съдържание.

* Нека в организация А е регистрирана преписка А1, в която се намират иницииращ документ Д1 и още един Д2. В организация Б се изпраща документ Д2. Тогава:

	* `DocID`/`DocumentGUID` = Д2
	* `DocumentParentID`/`DocumentGUID` = Д1

	От страна на организация Б пристига документ Д2. В организация Б се изготвя документ-отговор, който трябва да се изпрати към организация А. Тук се разглеждат два подслучая:

	* **Д1 също е бил пратен до Б**. Това означава, че има регистрирана преписка с иницииращ Д1. Създава се отговор Д3 и се изпраща на организация по следния начин:

		* `DocID`/`DocumentGUID` = Д3
		* `DocumentParentID`/`DocumentGUID` = Д1

	* **Д1 не е бил пратен до Б**. Тогава в процеса на получаване на документ правим преписка с иницииращ Д2. В оргазация Б се регистрира документ – отговор Д3. В този случай Д3 се изпраща към организация А по следния начин:

		* `DocID`/`DocumentGUID` = Д3
		* `DocumentParentID`/`DocumentGUID` = Д2

* От страна на организация А се получава документ Д3. Той трябва да бъде обработен по следния начин:

	В базата данни се търси документ или преписка с GUID записан в елемента `DocumentParentID`/`DocumentGUID` (според горния пример Д1 или Д2).

		* Ако съществува документ с такъв GUID, полученият документ се прикрепя към нея, а
		* в противен случай се регистрира нова преписка.

#### Известие за състояние на документ

Този вид съобщение се използва като отговор на съобщение от вида заявление за регистриране на документ. То служи за да се извести страната изпращач, с какъв номер е регистриран изпратеният от нея документ.

#### Заявление за проверка на състоянието на документ

Този вид съобщение се използва за запитване на страната получател за статус и номер на изпратен до нея документ.

#### Известие за грешка

Този вид съобщение се използва когато в резултат от обработката на дадено съобщение възникне грешка. Чрез него страната изпратила съобщението породило грешката се известява за нея. Съдържа елемент `MessageGUID`, който представлява GUID на съобщението предизвикало грешката.

### Среда за обмен на съобщения

Осигурени са официална и тестова среда за обмен на съобщения, всяка от които има независим регистър на участниците. В официалната среда влизат единствено официални административни органи, докато в тестовата могат да бъдат включени организации заинтересовани от разработката на приложения използващи настоящия протокол. Включването на участници в едната или другата среда става по утвърдена от МТИТС процедура.

#### Тестова среда за обмен на съобщения

Тестовата среда за обмен на съобщения е Интернет. В него е публикуван тестов регистър на участниците.

**Препоръчително** е използването на HTTPS протокол за обмен в тестовата среда. За тестови цели е **позволено** публикуването на уеб услугите на и по HTTP протокол, като в този случай проверките на транспортните сертификати не се извършват.

Адрес на списъка с отменени сертификати на Информационно обслужване АД:

[http://stampit.org/crl/stampit\_edoc.crl](http://stampit.org/crl/stampit_edoc.crl)

Адрес на програмния интерфейс на регистъра:

[https://egov-docflow-dev.is-bg.net/service/](https://egov-docflow-dev.is-bg.net/service/)

Адрес на потребителския интерфейс на регистъра:

[https://egov-docflow-dev.is-bg.net/profile/](https://egov-docflow-dev.is-bg.net/profile/)

#### Официална среда за обмен на съобщения

Официалната среда за обмен на съобщения в VPN мрежа в рамките на НМДА.

**Задължително** е използването на HTTPS протокол за обмен на съобщения в официалната среда.

Адрес на списъка с отменени сертификати на Информационно обслужване АД:

[http://stampit.org/crl/stampit\_edoc.crl](http://stampit.org/crl/stampit_edoc.crl)

Адрес на програмния интерфейс на регистъра:

[https://egov-docflow.is-bg.net/service/](https://egov-docflow.is-bg.net/service/)

Адрес на потребителския интерфейс на регистъра:

[https://egov-docflow.is-bg.net/profile/](https://egov-docflow.is-bg.net/profile/)

Тъй като всички услуги работят в частната мрежа на НМДА, в която няма определен DNS сървър, и за да се избегнат конфликти на машинни имена и адреси, е необходимо на машините осъществяващи обмена на съобщения да бъдат добавени следните NS записи:

| **Име на машина**      | **IP адрес** |
| ---------------------- | ------------ |
| egov-docflow.is-bg.net | 10.89.2.200  |
| stampit.org            | 10.89.2.201  |

### Приложения

#### Приложение 1. Описание на услугата на регистъра

Вж. приложения файл [eGovRegistry.wsdl](eGovRegistry.wsdl).

#### Приложение 2. Описание на съобщенията на регистъра

Вж. приложения файл [eGovRegistry.xsd](eGovRegistry.xsd).

#### Приложение 3. Описание на услугата на участниците

Вж. приложения файл [eGovEndpoint.wsdl](eGovEndpoint.wsdl).

#### Приложение 4. Описание на съобщенията между участниците

Вж. приложения файл [eGovMessaging.xsd](eGovMessaging.xsd).

###

[^1]: Процедурата по включване на участник в обмена не е обект на настоящия документ.

[^2]: Процедурата по издаване и преиздаване на транспортните сертификати, както и техните параметри, не са обект на настоящия документ.

[^3]: Поддръжката на клонова структура на участниците на този етап е нефункционираща.

[^4]: Необходимо е въвеждането на уникален идентификатор на крайната точка за целите на синхронизацията.
